name: "Cockpit Health Check"

on:
  push:
    branches: [ main ]
    paths:
      - '**.nix'
      - '**.zsh'
      - 'flake.lock'
  pull_request:
    branches: [ main ]

jobs:
  # 1. Nixの構文と整合性チェック
  nix-check:
    name: ❄️ Nix Flake Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-unstable
    - name: Check Flake
      run: nix flake check --all-systems --no-build

  # 2. Zshの構文チェック (今回のエラーの元凶を根絶)
  zsh-check:
    name: �� Zsh Syntax Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install Zsh
      run: sudo apt-get install -y zsh
    - name: Check Scripts
      run: |
        # エラーがあれば即座にCIを失敗させる
        set -e
        echo "�� Checking Zsh syntax..."
        find . -name "*.zsh" -print0 | xargs -0 -I {} zsh -n {}
        echo "✅ All Zsh files are healthy."
